<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fileway - Verify OTP</title>
    <link rel="stylesheet" href="../styles/main.css">
</head>
<body>
    <!-- Title Bar -->
    <div class="titlebar">
        <div class="titlebar-title">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            Fileway
        </div>
        <div class="titlebar-buttons">
            <button class="titlebar-btn minimize" onclick="window.fileway.minimizeWindow()">
                <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
            </button>
            <button class="titlebar-btn close" onclick="window.fileway.closeWindow()">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container center">
        <div class="card auth-card fade-in">
            <!-- Back Button -->
            <button class="back-btn" onclick="window.fileway.navigateTo('login.html')">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                Back
            </button>

            <h2>Enter Verification Code</h2>
            <p class="subtitle">We sent a 6-digit code to <span class="text-accent" id="emailDisplay"></span></p>

            <!-- Form -->
            <form id="otpForm">
                <div class="form-group">
                    <input 
                        type="text" 
                        id="otp" 
                        class="form-input otp" 
                        placeholder="••••••"
                        maxlength="6"
                        pattern="[0-9]*"
                        inputmode="numeric"
                        autocomplete="one-time-code"
                        required
                    >
                </div>

                <p class="text-muted text-center mb-16" id="errorMsg" style="color: var(--error); display: none;">
                    Invalid OTP. Please try again.
                </p>

                <button type="submit" class="btn btn-primary" id="verifyBtn">
                    Verify
                </button>
            </form>

            <p class="text-muted text-center mt-24">
                Testing OTP: <span class="text-accent">123456</span>
            </p>
        </div>
    </div>

    <script>
        const form = document.getElementById('otpForm');
        const otpInput = document.getElementById('otp');
        const emailDisplay = document.getElementById('emailDisplay');
        const errorMsg = document.getElementById('errorMsg');
        const verifyBtn = document.getElementById('verifyBtn');

        // Get email from session storage
        const email = sessionStorage.getItem('pendingEmail');
        
        if (!email) {
            window.fileway.navigateTo('login.html');
        } else {
            emailDisplay.textContent = email;
        }

        // Auto-format OTP input (numbers only)
        otpInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const otp = otpInput.value.trim();
            
            if (otp.length !== 6) {
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="loader"></span>';
            errorMsg.style.display = 'none';

            try {
                const result = await window.fileway.verifyOtp(email, otp);
                
                if (result.success) {
                    sessionStorage.removeItem('pendingEmail');
                    
                    if (result.hasName) {
                        // User already has a name, go to home
                        window.fileway.navigateTo('home.html');
                    } else {
                        // First time user, ask for name
                        window.fileway.navigateTo('name.html');
                    }
                } else {
                    errorMsg.style.display = 'block';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify';
                    otpInput.value = '';
                    otpInput.focus();
                }
            } catch (err) {
                errorMsg.style.display = 'block';
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify';
            }
        });
    </script>
</body>
</html>
